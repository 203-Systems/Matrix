   1              		.syntax unified
   2              		.cpu cortex-m3
   3              		.fpu softvfp
   4              		.eabi_attribute 20, 1
   5              		.eabi_attribute 21, 1
   6              		.eabi_attribute 23, 3
   7              		.eabi_attribute 24, 1
   8              		.eabi_attribute 25, 1
   9              		.eabi_attribute 26, 1
  10              		.eabi_attribute 30, 4
  11              		.eabi_attribute 34, 1
  12              		.eabi_attribute 18, 4
  13              		.thumb
  14              		.file	"main.c"
  15              		.text
  16              	.Ltext0:
  17              		.cfi_sections	.debug_frame
  18              		.section	.text.startup.main,"ax",%progbits
  19              		.align	1
  20              		.global	main
  21              		.thumb
  22              		.thumb_func
  24              	main:
  25              	.LFB0:
  26              		.file 1 "main.c"
   1:main.c        **** /* *****************************************************************************
   2:main.c        **** * The MIT License
   3:main.c        **** *
   4:main.c        **** * Copyright (c) 2010 LeafLabs LLC.
   5:main.c        **** *
   6:main.c        **** * Permission is hereby granted, free of charge, to any person obtaining a copy
   7:main.c        **** * of this software and associated documentation files (the "Software"), to deal
   8:main.c        **** * in the Software without restriction, including without limitation the rights
   9:main.c        **** * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  10:main.c        **** * copies of the Software, and to permit persons to whom the Software is
  11:main.c        **** * furnished to do so, subject to the following conditions:
  12:main.c        **** *
  13:main.c        **** * The above copyright notice and this permission notice shall be included in
  14:main.c        **** * all copies or substantial portions of the Software.
  15:main.c        **** *
  16:main.c        **** * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  17:main.c        **** * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  18:main.c        **** * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  19:main.c        **** * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  20:main.c        **** * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  21:main.c        **** * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  22:main.c        **** * THE SOFTWARE.
  23:main.c        **** * ****************************************************************************/
  24:main.c        **** 
  25:main.c        **** /**
  26:main.c        **** *  @file main.c
  27:main.c        **** *
  28:main.c        **** *  @brief main loop and calling any hardware init stuff. timing hacks for EEPROM
  29:main.c        **** *  writes not to block usb interrupts. logic to handle 2 second timeout then
  30:main.c        **** *  jump to user code.
  31:main.c        **** *
  32:main.c        **** */
  33:main.c        **** 
  34:main.c        **** #include "common.h"
  35:main.c        **** #include "dfu.h"
  36:main.c        **** extern volatile dfuUploadTypes_t userUploadType;
  37:main.c        **** 
  38:main.c        **** int main()
  39:main.c        **** {
  27              		.loc 1 39 0
  28              		.cfi_startproc
  29              		@ args = 0, pretend = 0, frame = 0
  30              		@ frame_needed = 0, uses_anonymous_args = 0
  31              	.LVL0:
  32 0000 08B5     		push	{r3, lr}
  33              		.cfi_def_cfa_offset 8
  34              		.cfi_offset 3, -8
  35              		.cfi_offset 14, -4
  40:main.c        ****   bool no_user_jump = FALSE;
  41:main.c        ****   bool dont_wait = FALSE;
  42:main.c        **** 
  43:main.c        ****   systemReset(); // peripherals but not PC
  36              		.loc 1 43 0
  37 0002 FFF7FEFF 		bl	systemReset
  38              	.LVL1:
  44:main.c        ****   setupCLK();
  39              		.loc 1 44 0
  40 0006 FFF7FEFF 		bl	setupCLK
  41              	.LVL2:
  45:main.c        ****   setupLEDAndButton();
  42              		.loc 1 45 0
  43 000a FFF7FEFF 		bl	setupLEDAndButton
  44              	.LVL3:
  46:main.c        ****   setupUSB();
  45              		.loc 1 46 0
  46 000e FFF7FEFF 		bl	setupUSB
  47              	.LVL4:
  47:main.c        ****   setupFLASH();
  48              		.loc 1 47 0
  49 0012 FFF7FEFF 		bl	setupFLASH
  50              	.LVL5:
  48:main.c        **** 
  49:main.c        ****   switch(checkAndClearBootloaderFlag())
  51              		.loc 1 49 0
  52 0016 FFF7FEFF 		bl	checkAndClearBootloaderFlag
  53              	.LVL6:
  54 001a 0128     		cmp	r0, #1
  55 001c 0FD0     		beq	.L14
  56 001e 0228     		cmp	r0, #2
  57 0020 14D0     		beq	.L4
  58              	.LVL7:
  59              	.LBB2:
  50:main.c        ****   {
  51:main.c        ****     case 0x01:
  52:main.c        ****     no_user_jump = TRUE;
  53:main.c        **** 
  54:main.c        ****     #ifdef FASTBOOT
  55:main.c        ****     dont_wait = FALSE;
  56:main.c        ****     #endif
  57:main.c        **** 
  58:main.c        ****     #ifndef NOLED
  59:main.c        ****     strobePin(LED_BANK, LED_PIN, STARTUP_BLINKS, BLINK_FAST,LED_ON_STATE);
  60:main.c        ****     #endif
  61:main.c        ****     break;
  62:main.c        **** 
  63:main.c        ****     case 0x02:
  64:main.c        ****     dont_wait = TRUE;
  65:main.c        ****     break;
  66:main.c        **** 
  67:main.c        ****     default:
  68:main.c        **** 
  69:main.c        ****     #ifdef FASTBOOT
  70:main.c        ****     dont_wait = TRUE;
  71:main.c        ****     #endif
  72:main.c        **** 
  73:main.c        ****     #ifndef NOLED
  74:main.c        ****     strobePin(LED_BANK, LED_PIN, STARTUP_BLINKS, BLINK_FAST,LED_ON_STATE);
  75:main.c        ****     #endif
  76:main.c        **** 
  77:main.c        ****     if (!checkUserCode(USER_CODE_FLASH0X8005000) && !checkUserCode(USER_CODE_FLASH0X8002000))
  60              		.loc 1 77 0
  61 0022 1348     		ldr	r0, .L25
  62 0024 FFF7FEFF 		bl	checkUserCode
  63              	.LVL8:
  64 0028 18B1     		cbz	r0, .L5
  65              	.L7:
  78:main.c        ****     {
  79:main.c        ****       no_user_jump = TRUE;
  80:main.c        ****     }
  81:main.c        ****     else if (readButtonState())
  66              		.loc 1 81 0
  67 002a FFF7FEFF 		bl	readButtonState
  68              	.LVL9:
  69 002e 30B9     		cbnz	r0, .L14
  70 0030 0CE0     		b	.L4
  71              	.L5:
  77:main.c        ****     if (!checkUserCode(USER_CODE_FLASH0X8005000) && !checkUserCode(USER_CODE_FLASH0X8002000))
  72              		.loc 1 77 0 discriminator 1
  73 0032 1048     		ldr	r0, .L25+4
  74 0034 FFF7FEFF 		bl	checkUserCode
  75              	.LVL10:
  76 0038 0028     		cmp	r0, #0
  77 003a F6D1     		bne	.L7
  78 003c 06E0     		b	.L4
  79              	.LVL11:
  80              	.L14:
  81              	.LBE2:
  82              	.LBB3:
  82:main.c        ****     {
  83:main.c        ****       no_user_jump = TRUE;
  84:main.c        ****       #ifdef FASTBOOT
  85:main.c        ****       dont_wait = FALSE;
  86:main.c        ****       #endif
  87:main.c        ****     }
  88:main.c        ****     break;
  89:main.c        ****   }
  90:main.c        **** 
  91:main.c        ****   if (!dont_wait)
  92:main.c        ****   {
  93:main.c        ****     int delay_count = 0;
  94:main.c        **** 
  95:main.c        ****     while ((delay_count++ < BOOTLOADER_WAIT) || no_user_jump)
  96:main.c        ****     {
  97:main.c        ****       #ifndef NOLED
  98:main.c        ****       strobePin(LED_BANK, LED_PIN, 1, BLINK_SLOW,LED_ON_STATE);
  99:main.c        ****       #endif
 100:main.c        ****       if (dfuUploadStarted())
  83              		.loc 1 100 0 discriminator 1
  84 003e FFF7FEFF 		bl	dfuUploadStarted
  85              	.LVL12:
  86 0042 0028     		cmp	r0, #0
  87 0044 FBD0     		beq	.L14
 101:main.c        ****       {
 102:main.c        ****         dfuFinishUpload(); // systemHardReset from DFU once done
  88              		.loc 1 102 0
  89 0046 FFF7FEFF 		bl	dfuFinishUpload
  90              	.LVL13:
  91 004a F8E7     		b	.L14
  92              	.L4:
  93              	.LVL14:
  94              	.LBE3:
 103:main.c        ****       }
 104:main.c        **** 
 105:main.c        ****       // if(readButtonState())
 106:main.c        ****       // {
 107:main.c        ****       //   break;
 108:main.c        ****       // }
 109:main.c        ****     }
 110:main.c        ****   }
 111:main.c        **** 
 112:main.c        ****   if (checkUserCode(USER_CODE_FLASH0X8002000))
  95              		.loc 1 112 0
  96 004c 0948     		ldr	r0, .L25+4
  97 004e FFF7FEFF 		bl	checkUserCode
  98              	.LVL15:
  99 0052 08B1     		cbz	r0, .L22
 113:main.c        ****   {
 114:main.c        ****     jumpToUser(USER_CODE_FLASH0X8002000);
 100              		.loc 1 114 0
 101 0054 0748     		ldr	r0, .L25+4
 102 0056 04E0     		b	.L23
 103              	.L22:
 115:main.c        ****   }
 116:main.c        ****   else
 117:main.c        ****   {
 118:main.c        ****     if (checkUserCode(USER_CODE_FLASH0X8005000))
 104              		.loc 1 118 0
 105 0058 0548     		ldr	r0, .L25
 106 005a FFF7FEFF 		bl	checkUserCode
 107              	.LVL16:
 108 005e 18B1     		cbz	r0, .L11
 119:main.c        ****     {
 120:main.c        ****       jumpToUser(USER_CODE_FLASH0X8005000);
 109              		.loc 1 120 0
 110 0060 0348     		ldr	r0, .L25
 111              	.L23:
 112 0062 FFF7FEFF 		bl	jumpToUser
 113              	.LVL17:
 114 0066 01E0     		b	.L21
 115              	.L11:
 121:main.c        ****     }
 122:main.c        ****     else
 123:main.c        ****     {
 124:main.c        ****       // Nothing to execute in either Flash or RAM
 125:main.c        ****       #ifndef NOLED
 126:main.c        ****       strobePin(LED_BANK, LED_PIN, 5, BLINK_FAST,LED_ON_STATE);
 127:main.c        ****       #endif
 128:main.c        **** 
 129:main.c        ****       systemHardReset();
 116              		.loc 1 129 0
 117 0068 FFF7FEFF 		bl	systemHardReset
 118              	.LVL18:
 119              	.L21:
 130:main.c        ****     }
 131:main.c        ****   }
 132:main.c        **** 
 133:main.c        ****   return 0;// Added to please the compiler
 134:main.c        **** }
 120              		.loc 1 134 0
 121 006c 0020     		movs	r0, #0
 122 006e 08BD     		pop	{r3, pc}
 123              	.L26:
 124              		.align	2
 125              	.L25:
 126 0070 00500008 		.word	134238208
 127 0074 00200008 		.word	134225920
 128              		.cfi_endproc
 129              	.LFE0:
 131              		.comm	wTransferSize,4,4
 132              		.text
 133              	.Letext0:
 134              		.file 2 "dfu.h"
 135              		.file 3 "hardware.h"
 136              		.file 4 "usb.h"
 137              		.file 5 "./stm32_lib/stm32f10x_type.h"
DEFINED SYMBOLS
                            *ABS*:0000000000000000 main.c
     /tmp/ccpdhTGL.s:19     .text.startup.main:0000000000000000 $t
     /tmp/ccpdhTGL.s:24     .text.startup.main:0000000000000000 main
     /tmp/ccpdhTGL.s:126    .text.startup.main:0000000000000070 $d
                            *COM*:0000000000000004 wTransferSize
                     .debug_frame:0000000000000010 $d

UNDEFINED SYMBOLS
systemReset
setupCLK
setupLEDAndButton
setupUSB
setupFLASH
checkAndClearBootloaderFlag
checkUserCode
readButtonState
dfuUploadStarted
dfuFinishUpload
jumpToUser
systemHardReset
