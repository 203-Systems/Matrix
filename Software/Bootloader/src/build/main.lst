   1              		.syntax unified
   2              		.cpu cortex-m3
   3              		.fpu softvfp
   4              		.eabi_attribute 20, 1
   5              		.eabi_attribute 21, 1
   6              		.eabi_attribute 23, 3
   7              		.eabi_attribute 24, 1
   8              		.eabi_attribute 25, 1
   9              		.eabi_attribute 26, 1
  10              		.eabi_attribute 30, 4
  11              		.eabi_attribute 34, 1
  12              		.eabi_attribute 18, 4
  13              		.thumb
  14              		.file	"main.c"
  15              		.text
  16              	.Ltext0:
  17              		.cfi_sections	.debug_frame
  18              		.section	.text.startup.main,"ax",%progbits
  19              		.align	1
  20              		.global	main
  21              		.thumb
  22              		.thumb_func
  24              	main:
  25              	.LFB0:
  26              		.file 1 "main.c"
   1:main.c        **** /* *****************************************************************************
   2:main.c        **** * The MIT License
   3:main.c        **** *
   4:main.c        **** * Copyright (c) 2010 LeafLabs LLC.
   5:main.c        **** *
   6:main.c        **** * Permission is hereby granted, free of charge, to any person obtaining a copy
   7:main.c        **** * of this software and associated documentation files (the "Software"), to deal
   8:main.c        **** * in the Software without restriction, including without limitation the rights
   9:main.c        **** * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  10:main.c        **** * copies of the Software, and to permit persons to whom the Software is
  11:main.c        **** * furnished to do so, subject to the following conditions:
  12:main.c        **** *
  13:main.c        **** * The above copyright notice and this permission notice shall be included in
  14:main.c        **** * all copies or substantial portions of the Software.
  15:main.c        **** *
  16:main.c        **** * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  17:main.c        **** * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  18:main.c        **** * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  19:main.c        **** * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  20:main.c        **** * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  21:main.c        **** * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  22:main.c        **** * THE SOFTWARE.
  23:main.c        **** * ****************************************************************************/
  24:main.c        **** 
  25:main.c        **** /**
  26:main.c        **** *  @file main.c
  27:main.c        **** *
  28:main.c        **** *  @brief main loop and calling any hardware init stuff. timing hacks for EEPROM
  29:main.c        **** *  writes not to block usb interrupts. logic to handle 2 second timeout then
  30:main.c        **** *  jump to user code.
  31:main.c        **** *
  32:main.c        **** */
  33:main.c        **** 
  34:main.c        **** #include "common.h"
  35:main.c        **** #include "dfu.h"
  36:main.c        **** extern volatile dfuUploadTypes_t userUploadType;
  37:main.c        **** 
  38:main.c        **** int main()
  39:main.c        **** {
  27              		.loc 1 39 0
  28              		.cfi_startproc
  29              		@ args = 0, pretend = 0, frame = 0
  30              		@ frame_needed = 0, uses_anonymous_args = 0
  31              	.LVL0:
  32 0000 08B5     		push	{r3, lr}
  33              		.cfi_def_cfa_offset 8
  34              		.cfi_offset 3, -8
  35              		.cfi_offset 14, -4
  40:main.c        ****   bool no_user_jump = FALSE;
  41:main.c        ****   bool dont_wait = FALSE;
  42:main.c        **** 
  43:main.c        ****   systemReset(); // peripherals but not PC
  36              		.loc 1 43 0
  37 0002 FFF7FEFF 		bl	systemReset
  38              	.LVL1:
  44:main.c        ****   setupCLK();
  39              		.loc 1 44 0
  40 0006 FFF7FEFF 		bl	setupCLK
  41              	.LVL2:
  45:main.c        ****   setupLEDAndButton();
  42              		.loc 1 45 0
  43 000a FFF7FEFF 		bl	setupLEDAndButton
  44              	.LVL3:
  46:main.c        ****   setupUSB();
  45              		.loc 1 46 0
  46 000e FFF7FEFF 		bl	setupUSB
  47              	.LVL4:
  47:main.c        ****   setupFLASH();
  48              		.loc 1 47 0
  49 0012 FFF7FEFF 		bl	setupFLASH
  50              	.LVL5:
  48:main.c        **** 
  49:main.c        ****   switch(checkAndClearBootloaderFlag())
  51              		.loc 1 49 0
  52 0016 FFF7FEFF 		bl	checkAndClearBootloaderFlag
  53              	.LVL6:
  54 001a 0128     		cmp	r0, #1
  55 001c 0ED0     		beq	.L14
  56 001e 0228     		cmp	r0, #2
  57 0020 13D0     		beq	.L4
  58              	.LVL7:
  59              	.LBB2:
  50:main.c        ****   {
  51:main.c        ****     case 0x01:
  52:main.c        ****     no_user_jump = TRUE;
  53:main.c        **** 
  54:main.c        ****     #ifdef FASTBOOT
  55:main.c        ****     dont_wait = FALSE;
  56:main.c        ****     #endif
  57:main.c        **** 
  58:main.c        ****     #ifndef NOLED
  59:main.c        ****     strobePin(LED_BANK, LED_PIN, STARTUP_BLINKS, BLINK_FAST,LED_ON_STATE);
  60:main.c        ****     #endif
  61:main.c        ****     break;
  62:main.c        **** 
  63:main.c        ****     case 0x02:
  64:main.c        ****     dont_wait = TRUE;
  65:main.c        ****     break;
  66:main.c        **** 
  67:main.c        ****     default:
  68:main.c        **** 
  69:main.c        ****     #ifdef FASTBOOT
  70:main.c        ****     dont_wait = TRUE;
  71:main.c        ****     #endif
  72:main.c        **** 
  73:main.c        ****     #ifndef NOLED
  74:main.c        ****     strobePin(LED_BANK, LED_PIN, STARTUP_BLINKS, BLINK_FAST,LED_ON_STATE);
  75:main.c        ****     #endif
  76:main.c        **** 
  77:main.c        ****     if ((!checkUserCode(USER_CODE_FLASH0X8005000) && !checkUserCode(USER_CODE_FLASH0X8002000)) || r
  60              		.loc 1 77 0
  61 0022 1348     		ldr	r0, .L25
  62 0024 FFF7FEFF 		bl	checkUserCode
  63              	.LVL8:
  64 0028 18B1     		cbz	r0, .L5
  65              	.L7:
  66 002a FFF7FEFF 		bl	readButtonState
  67              	.LVL9:
  68 002e 28B9     		cbnz	r0, .L14
  69 0030 0BE0     		b	.L4
  70              	.L5:
  71              		.loc 1 77 0 is_stmt 0 discriminator 1
  72 0032 1048     		ldr	r0, .L25+4
  73 0034 FFF7FEFF 		bl	checkUserCode
  74              	.LVL10:
  75 0038 0028     		cmp	r0, #0
  76 003a F6D1     		bne	.L7
  77              	.LVL11:
  78              	.L14:
  79              	.LBE2:
  80              	.LBB3:
  78:main.c        ****     {
  79:main.c        ****       no_user_jump = TRUE;
  80:main.c        ****       #ifdef FASTBOOT
  81:main.c        ****       dont_wait = FALSE;
  82:main.c        ****       #endif
  83:main.c        ****     }
  84:main.c        ****     break;
  85:main.c        ****   }
  86:main.c        **** 
  87:main.c        ****   if (!dont_wait)
  88:main.c        ****   {
  89:main.c        ****     int delay_count = 0;
  90:main.c        **** 
  91:main.c        ****     while ((delay_count++ < BOOTLOADER_WAIT) || no_user_jump)
  92:main.c        ****     {
  93:main.c        ****       #ifndef NOLED
  94:main.c        ****       strobePin(LED_BANK, LED_PIN, 1, BLINK_SLOW,LED_ON_STATE);
  95:main.c        ****       #endif
  96:main.c        ****       if (dfuUploadStarted())
  81              		.loc 1 96 0 is_stmt 1 discriminator 1
  82 003c FFF7FEFF 		bl	dfuUploadStarted
  83              	.LVL12:
  84 0040 0028     		cmp	r0, #0
  85 0042 FBD0     		beq	.L14
  97:main.c        ****       {
  98:main.c        ****         dfuFinishUpload(); // systemHardReset from DFU once done
  86              		.loc 1 98 0
  87 0044 FFF7FEFF 		bl	dfuFinishUpload
  88              	.LVL13:
  89 0048 F8E7     		b	.L14
  90              	.L4:
  91              	.LVL14:
  92              	.LBE3:
  99:main.c        ****       }
 100:main.c        **** 
 101:main.c        ****       // if(readButtonState())
 102:main.c        ****       // {
 103:main.c        ****       //   break;
 104:main.c        ****       // }
 105:main.c        ****     }
 106:main.c        ****   }
 107:main.c        **** 
 108:main.c        ****   if (checkUserCode(USER_CODE_FLASH0X8002000))
  93              		.loc 1 108 0
  94 004a 0A48     		ldr	r0, .L25+4
  95 004c FFF7FEFF 		bl	checkUserCode
  96              	.LVL15:
  97 0050 08B1     		cbz	r0, .L22
 109:main.c        ****   {
 110:main.c        ****     jumpToUser(USER_CODE_FLASH0X8002000);
  98              		.loc 1 110 0
  99 0052 0848     		ldr	r0, .L25+4
 100 0054 04E0     		b	.L23
 101              	.L22:
 111:main.c        ****   }
 112:main.c        ****   else
 113:main.c        ****   {
 114:main.c        ****     if (checkUserCode(USER_CODE_FLASH0X8005000))
 102              		.loc 1 114 0
 103 0056 0648     		ldr	r0, .L25
 104 0058 FFF7FEFF 		bl	checkUserCode
 105              	.LVL16:
 106 005c 18B1     		cbz	r0, .L11
 115:main.c        ****     {
 116:main.c        ****       jumpToUser(USER_CODE_FLASH0X8005000);
 107              		.loc 1 116 0
 108 005e 0448     		ldr	r0, .L25
 109              	.L23:
 110 0060 FFF7FEFF 		bl	jumpToUser
 111              	.LVL17:
 112 0064 01E0     		b	.L21
 113              	.L11:
 117:main.c        ****     }
 118:main.c        ****     else
 119:main.c        ****     {
 120:main.c        ****       // Nothing to execute in either Flash or RAM
 121:main.c        ****       #ifndef NOLED
 122:main.c        ****       strobePin(LED_BANK, LED_PIN, 5, BLINK_FAST,LED_ON_STATE);
 123:main.c        ****       #endif
 124:main.c        **** 
 125:main.c        ****       systemHardReset();
 114              		.loc 1 125 0
 115 0066 FFF7FEFF 		bl	systemHardReset
 116              	.LVL18:
 117              	.L21:
 126:main.c        ****     }
 127:main.c        ****   }
 128:main.c        **** 
 129:main.c        ****   return 0;// Added to please the compiler
 130:main.c        **** }
 118              		.loc 1 130 0
 119 006a 0020     		movs	r0, #0
 120 006c 08BD     		pop	{r3, pc}
 121              	.L26:
 122 006e 00BF     		.align	2
 123              	.L25:
 124 0070 00500008 		.word	134238208
 125 0074 00200008 		.word	134225920
 126              		.cfi_endproc
 127              	.LFE0:
 129              		.comm	wTransferSize,4,4
 130              		.text
 131              	.Letext0:
 132              		.file 2 "dfu.h"
 133              		.file 3 "hardware.h"
 134              		.file 4 "usb.h"
 135              		.file 5 "./stm32_lib/stm32f10x_type.h"
DEFINED SYMBOLS
                            *ABS*:0000000000000000 main.c
     /tmp/ccaXf0vc.s:19     .text.startup.main:0000000000000000 $t
     /tmp/ccaXf0vc.s:24     .text.startup.main:0000000000000000 main
     /tmp/ccaXf0vc.s:124    .text.startup.main:0000000000000070 $d
                            *COM*:0000000000000004 wTransferSize
                     .debug_frame:0000000000000010 $d

UNDEFINED SYMBOLS
systemReset
setupCLK
setupLEDAndButton
setupUSB
setupFLASH
checkAndClearBootloaderFlag
checkUserCode
readButtonState
dfuUploadStarted
dfuFinishUpload
jumpToUser
systemHardReset
